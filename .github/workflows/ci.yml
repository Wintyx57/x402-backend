name: Backend CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Run unit tests (no network required)
        run: node --test tests/payment.test.js tests/chains.test.js tests/monitor.test.js tests/services-logic.test.js tests/validation.test.js tests/logger.test.js tests/register-validation.test.js tests/budget.test.js tests/activity.test.js tests/middleware.test.js tests/new-apis.test.js tests/telegram-bot.test.js

  e2e-tests:
    name: E2E Tests (production)
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Wake up Render server
        run: curl -sf --max-time 60 https://x402-api.onrender.com/health || echo "Server may be cold-starting, continuing..."
      - name: Run E2E tests against production
        run: node --test tests/e2e.test.js
        env:
          ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
        # E2E tests hit production â€” may fail due to cold starts or network issues
        # Admin tests require ADMIN_TOKEN secret to be configured in GitHub Actions
        continue-on-error: true

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm audit --audit-level=high
